# Piper general purpose pipeline
# This pipeline was generated by Hyperspace Onboarding
# To modify the pipeline or add additional steps please check:
# https://github.wdf.sap.corp/pages/ContinuousDelivery/piper-doc/stages/
general:
  buildTool: 'golang'
  productiveBranch: 'main'

  repository: &REPOSITORY_NAME 'quota-operator'
  owner: 'CoLa'
  githubApiUrl: 'https://github.tools.sap/api/v3'
  githubServerUrl: 'https://github.tools.sap'
  privateModules: 'github.tools.sap/*'

  vaultPath: 'piper/PIPELINE-GROUP-5266'
  vaultBasePath: 'piper/PIPELINE-GROUP-5266'
  vaultPipelineName: 'PIPELINE-37428'
  vaultServerUrl: 'https://vault.tools.sap'
  vaultNamespace: 'ies/hyperspace/pipelines'
  nativeBuild: true

  whitesourceProductName: 'CTNR - COLA QUOTA OPERATOR'
  whitesourceProductToken: '66aecaf8901f4208bdf0b9886f62f1f864efd48c4a674efb8c4eec518a57477d'

stages:
  Build:
    hadolintExecute: false
    kanikoExecute: true
    helmExecute: true
  Release:
    sapDownloadArtifact: false
    githubPublishRelease: true

steps:
  artifactPrepareVersion:
    versioningType: library
    gitHttpsCredentialVaultSecretName: 'GROUP-SECRETS/github-cola-serviceuser'
  sapCallStagingService:
    url: 'https://staging.repositories.cloud.sap/stage/api'
    profile: 'group-5266-default'
  kanikoExecute:
    buildOptions: ['--skip-unused-stages', '--build-arg', 'BUILDENV=piper','--build-arg', 'BUILD_TIMESTAMP', '--build-arg', 'GIT_COMMIT', '--build-arg', 'TARGETOS=linux', '--build-arg', 'TARGETARCH=amd64', '--build-arg', 'COMPONENT=quota-operator']
    containerImageName: openmcp/quota-operator
  sapCumulusUpload:
    pipelineId: '54ddf82c-087c-49fa-9029-21ef10ca3e7b'
  sapCheckPPMSCompliance:
    ppmsID: '73554900100200024474'
  dockerExecute:
    dockerImage: 'debian:stable'
  golangBuild:
    privateModules: 'github.tools.sap/*'
    dockerImage: &GOLANG_BUILDER 'golang:1.23'
    output: 'bin/quota-operator'
    packages:
      - './cmd/quota-operator/main.go'
    runTests: true
    runIntegrationTests: false
  githubPublishRelease:
    addDeltaToLastRelease: true
    addClosedIssues: true
  helmExecute:
    chartPath: charts/quota-operator
    publish: true
  checkmarxExecuteScan:
    projectName: *REPOSITORY_NAME
    vulnerabilityThresholdEnabled: false
    teamName: '/CxServer/SP/SAP/BUSINESS_TECHNOLOGY_PLATFORM/COMPONENTS/CLOUD_ORCHESTRATION'
    filterPattern: '**/*.go, !**/*_test.go, !**/vendor/**, !**/test/**, !**/hack/**, !api/**, !**/zz_*.go, !**/*.yml, !**/*.yaml'
    preset: 100099 # SAP_Default_Go
  whitesourceExecuteScan:
    dockerImage: *GOLANG_BUILDER
    privateModules: 'github.tools.sap/*'
    dockerEnvVars:
      GOFLAGS: "-mod=mod -buildvcs=false"
    failOnSevereVulnerabilities: false
  sapCheckPPMSCompliance:
    ppmsID: '73554900100200024474'
    uploadChangeRequest: true
